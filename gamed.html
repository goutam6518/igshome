<!DOCTYPE html>
<html>
<head>
  <title>Game Download</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">

  <style>
    /* (Your original styling skipped here for brevity) */

    .star-rating {
      display: inline-block;
      font-size: 2em;
      color: #444;
      cursor: pointer;
    }
    .star-rating .star {
      display: inline-block;
    }
    .star-rating .filled {
      color: gold;
    }
    .studio-banner {
      background: #FFD700;
      color: #000;
      padding: 10px;
      margin: 20px 0;
      font-size: 1.2em;
      cursor: pointer;
    }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, updateDoc, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-auth.js";

    const firebaseConfig = {/* your config */};
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const params = new URLSearchParams(window.location.search);
    const gameId = params.get('id');

    let currentUser = null;
    let userRating = 0;

    window.onload = async () => {
      const loader = document.getElementById('loading');
      const section = document.getElementById('gameSection');
      const errorDiv = document.getElementById('error');
      loader.style.display = 'block';

      if (!gameId) {
        errorDiv.textContent = 'No game ID provided.';
        loader.style.display = 'none';
        return;
      }

      try {
        const snap = await getDoc(doc(db, 'games', gameId));
        if (!snap.exists()) throw new Error('Game not found');
        const game = snap.data();

        document.getElementById('logo').src = game.gameLogoUrl;
        document.getElementById('name').textContent = game.gameName;
        document.getElementById('fileSize').textContent = `Size ${game.fileSize || "Unknown"}`;

        const downloadLabel = document.getElementById('downloads');
        let downloadCount = game.downloadsCount || 0;
        downloadLabel.textContent = `${downloadCount} Downloads`;

        // Studio banner
        const banner = document.getElementById('studioBanner');
        banner.textContent = game.uploaderName;
        banner.onclick = () => window.location.href = `profile.html?user=${encodeURIComponent(game.uploaderId)}`;

        // Rating UI
        const avg = game.ratingSum / (game.ratingCount || 1);
        document.getElementById('avgRating').textContent = avg.toFixed(1);

        // Stars components
        const stars = document.querySelectorAll('#starContainer .star');
        stars.forEach((star, idx) => {
          star.onmouseenter = () => fillStars(idx);
          star.onclick = async () => {
            if (!currentUser) return alert('Login to rate');
            userRating = idx + 1;
            await updateRating();
          };
        });

        loader.style.display = 'none';
        section.style.display = 'block';
      } catch (e) {
        loader.style.display = 'none';
        errorDiv.textContent = e.message;
      }
    };

    onAuthStateChanged(auth, user => {
      currentUser = user;
      const tracker = document.getElementById('clickTracker');
      if (user) {
        tracker.style.display = 'block';
        document.querySelectorAll('.bottom-nav button').forEach(btn => {
          btn.onclick = () => incrementDownload();
        });
      } else {
        tracker.style.display = 'none';
      }
    });

    async function incrementDownload() {
      const downloadsEl = document.getElementById('downloads');
      let val = parseInt(downloadsEl.textContent);
      downloadsEl.textContent = `${++val} Downloads`;
      await updateDoc(doc(db, 'games', gameId), { downloadsCount: val });
    }

    function fillStars(toIdx) {
      document.querySelectorAll('#starContainer .star').forEach((s, i) => {
        s.classList.toggle('filled', i <= toIdx);
      });
    }

    async function updateRating() {
      const gameRef = doc(db, 'games', gameId);
      await updateDoc(gameRef, {
        ratingSum: firebase.firestore.FieldValue.increment(userRating),
        ratingCount: firebase.firestore.FieldValue.increment(1),
      });
      fillStars(userRating - 1);
    }
  </script>
</head>
<body>
  <div id="loading"><h3>Loading game...</h3></div>
  <div id="gameSection" style="display:none">
    <img id="logo"><h1 id="name"></h1>
    <div id="studioBanner" class="studio-banner"></div>
    <div class="info-container">
      <div id="fileSize"></div><div id="downloads"></div>
    </div>
    <button id="downloadBtn" class="btn">Download</button>

    <div class="screenshots-container" id="screenshots"></div>

    <div>
      <span id="avgRating">0.0</span>/8 average rating
      <div id="starContainer" class="star-rating">
        <!-- 8 stars -->
        <span class="star">&#9733;</span><span class="star">&#9733;</span>
        <span class="star">&#9733;</span><span class="star">&#9733;</span>
        <span class="star">&#9733;</span><span class="star">&#9733;</span>
        <span class="star">&#9733;</span><span class="star">&#9733;</span>
      </div>
    </div>
  </div>

  <div id="error" style="color:red"></div>

  <p id="clickTracker" style="display:none; text-align:center; color:#aaa; font-size:0.9em;">
    Bottom button clicks count as Downloads.
  </p>

  <div class="bottom-nav">
    <button>Home</button><button>Games</button><button>Profile</button>
  </div>
</body>
</html>
